

current_value = 'fin'
var setNewValues = function () {
    current_value =  $(this).parent().attr("data")
    redrawStatusChart();
}


//var current_status_data = finance_status_data;
$(function (){
    status_chart=new Highcharts.Chart({
        credits:  {
            enabled: false
        },
        chart: {
            renderTo:'apartment-status-chart',
            type: 'column'
        },
        title: {
            text: 'Статусы квартир'
        },
        xAxis: {
            categories: getWeeksStartsForCategories(),
            tickmarkPlacement: 'on'
        },
        yAxis:{
            title: {
                text: ''
            }
        },
        tooltip: {
            shared: true
//            formatter: function() {
//                var s = '<b>'+ this.x +'</b>';
//
//                $.each(this.points, function(i, point) {
//                    s += '<br/>'+ point.series.name +': '+
//                            point.y + " " + current_status_data['valueSuffix'];
//                });
//
//                return s;
//            }
//              valueSuffix: 'млн рублей'
        },
        series: [{
            name: 'ПС',
            data: []
        },
        {
            name: 'ДКП',
            data: []
        },
        {
            name: 'Аукцион',
            data: []
        },
        {
            name: 'Имеет заявку',
            data: []
        },
        {
            name: 'Свободна',
            data: []
        }]
    });

    redrawStatusChart = function(){
        weeks_group={
            'ПС':[],
            'ДКП':[],
            'Аукцион':[],
            'Имеет заявку': [],
            'Свободна': []
        };
        $.each(filtered_apartments, function(i,val){

            ps_date = moment(val.ps_date)
            dkp_date = moment(val.dkp_date)
            auk_date = moment(val.auction_date)
            has_qty_date = moment(val.has_qty_date)
            free_date = moment(val.free_date)
            $.each(getWeeksStarts(), function(t,week){
                //опрделяем статус квартиры на текущей неделе

                if (weeks_group['ПС'][t]==null) weeks_group['ПС'][t]={count:0, fin:0, m2:0}
                if (weeks_group['ДКП'][t]==null) weeks_group['ДКП'][t]={count:0, fin:0, m2:0}
                if (weeks_group['Аукцион'][t]==null) weeks_group['Аукцион'][t]={count:0, fin:0, m2:0}
                if (weeks_group['Имеет заявку'][t]==null) weeks_group['Имеет заявку'][t]={count:0, fin:0, m2:0}
                if (weeks_group['Свободна'][t]==null) weeks_group['Свободна'][t]={count:0, fin:0, m2:0}

                //доавляем квартиру в статус ПС если дата была когда либо до этой даты.
                if (ps_date.diff(week, 'days')<0)
                {
                    weeks_group['ПС'][t]['count']++;
                    weeks_group['ПС'][t]['fin']+=val.end_sum
                    weeks_group['ПС'][t]['m2']+=val.square
                }

                //добавляем квартиру в дкп если дата у нее дата дкп была до это недели и она еще не перешла в статус ПС
                if (dkp_date.diff(week, 'days')<0 && (ps_date.diff(week, 'days')>=0 || ps_date==null))
                {
                    weeks_group['ДКП'][t]['count']++;
                    weeks_group['ДКП'][t]['fin']+=val.end_sum
                    weeks_group['ДКП'][t]['m2']+=val.square
                }

                //добавляем квартиру в аук если дата у нее дата аук была до это недели и она еще не перешла в статус ДКП
                if (auk_date.diff(week, 'days')<0 && (dkp_date.diff(week, 'days')>=0 || dkp_date==null))
                {
                    weeks_group['Аукцион'][t]['count']++;
                    weeks_group['Аукцион'][t]['fin']+=val.end_sum
                    weeks_group['Аукцион'][t]['m2']+=val.square
                }

                if (has_qty_date.diff(week, 'days')<0 && (auk_date.diff(week, 'days')>=0 || auk_date==null))
                {
                    weeks_group['Имеет заявку'][t]['count']++;
                    weeks_group['Имеет заявку'][t]['fin']+=val.end_sum
                    weeks_group['Имеет заявку'][t]['m2']+=val.square
                }

                if (free_date.diff(week, 'days')<0 && (has_qty_date.diff(week, 'days')<7 || has_qty_date==null))
                {
                    weeks_group['Свободна'][t]['count']++;
                    weeks_group['Свободна'][t]['fin']+=val.end_sum
                    weeks_group['Свободна'][t]['m2']+=val.square
                }
            })
        })
        // object {status: array[counts, fin, m2 in weeks]}

        weeks_data = {};

        $.each(weeks_group, function(i,status_data){
            console.log(status_data)
            if(weeks_data[i]==null) weeks_data[i]={name: i,data:[]}

            $.each(status_data, function(t, week_status_data){
                weeks_data[i]['data'].push(week_status_data[current_value])
            })

        })

        var t = 0
        $.each (weeks_data, function (i,ser){
            status_chart.series[t++].setData(ser.data, false);
        })
        status_chart.redraw();
    }

    redrawStatusChart();
});







